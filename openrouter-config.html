<script type="text/javascript">
    RED.nodes.registerType('openrouter-config', {
        category: 'config',
        defaults: {
            name: {value: ""},
            model: {value: ""}
        },
        credentials: {
            apiKey: {type: "password"},
            siteUrl: {type: "text"},
            siteName: {type: "text"}
        },
        label: function() {
            var label = this.name || "OpenRouter Config";
            if (this.model) {
                label += ` (${this.model})`;
            }
            return label;
        },
        oneditprepare: function() {
            var node = this;
            node.models = [];
            fetch('https://openrouter.ai/api/v1/models')
                .then(response => response.json())
                .then(data => {
                    node.models = data.data || [];
                    if (node.model) {
                        $('#node-input-model-id').val(node.model);
                        // Find matching model for display
                        var match = node.models.find(m => m.id === node.model);
                        if (match && match.name) {
                            $('#model-name-display').text(` - ${match.name}`);
                        }
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch models:', err);
                    node.warn('Could not load models list. Enter model ID manually.');
                });

            var input = $('#node-input-model-id');
            var display = $('#model-name-display');
            var dropdown = $('#model-dropdown');

            input.on('input keyup', function(e) {
                if (e.keyCode === 27) { // ESC
                    dropdown.hide();
                    return;
                }
                var term = input.val().toLowerCase().trim();
                dropdown.empty().hide();
                if (term.length < 1) return;

                var matches = node.models.filter(m => 
                    m.id.toLowerCase().includes(term) || 
                    (m.name && m.name.toLowerCase().includes(term))
                ).slice(0, 50);

                matches.forEach(model => {
                    var div = $('<div style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; line-height: 1.4;">')
                        .html(`<div style="font-weight: bold; font-size: 14px;">${model.id}</div><div style="color: #666; font-size: 12px; margin-top: 2px;">${model.name || 'No name'}</div>`)
                        .hover(function() { $(this).css('background-color', '#f5f5f5'); }, function() { $(this).css('background-color', 'white'); })
                        .on('click', function() {
                            node.model = model.id;
                            input.val(model.id);
                            display.text(model.name ? ` - ${model.name}` : '');
                            dropdown.hide();
                        });
                    dropdown.append(div);
                });

                if (matches.length > 0) {
                    dropdown.css('width', input.parent().outerWidth()).show();
                }
            });

            // Allow manual entry: on blur, try to find matching model and set string
            input.on('blur', function() {
                var val = input.val().trim();
                if (val && node.model !== val) {
                    var match = node.models.find(m => m.id === val || (m.name && m.name.toLowerCase() === val.toLowerCase()));
                    if (match) {
                        node.model = match.id;
                        display.text(match.name ? ` - ${match.name}` : '');
                    } else {
                        node.model = val;
                        display.text('');
                        // Only warn if not already set
                        if (node.model !== val) node.warn('Unknown model ID; verify manually.');
                    }
                }
            });

            // Hide dropdown when clicking outside
            $(document).off('click.model-hide').on('click.model-hide', function(e) {
                if (!input.is(e.target) && !input.parent().is(e.target) && dropdown.has(e.target).length === 0) {
                    dropdown.hide();
                }
            });

            // Show all on focus if empty
            input.on('focus', function() {
                if (input.val().trim() === '' && node.models.length > 0) {
                    input.trigger('input');
                }
            });
        }

        // Site selector logic
        var siteSelector = $('#node-input-site-selector');
        var editBtn = $('#edit-site-btn');
        var customFields = $('#custom-site-fields');
        var siteUrlInput = $('#node-config-input-siteUrl');
        var siteNameInput = $('#node-config-input-siteName');

        // Preload site values
        var currentSiteUrl = node.credentials.siteUrl || '';
        var currentSiteName = node.credentials.siteName || '';
        if (currentSiteUrl === 'https://openrouter.ai' && currentSiteName === 'OpenRouter') {
            siteSelector.val('default');
            customFields.hide();
        } else {
            siteSelector.val('custom');
            siteUrlInput.val(currentSiteUrl);
            siteNameInput.val(currentSiteName);
            customFields.show();
        }

        siteSelector.on('change', function() {
            if (this.value === 'default') {
                siteUrlInput.val('https://openrouter.ai');
                siteNameInput.val('OpenRouter');
                customFields.hide();
                // Update credentials on change
                node.credentials.siteUrl = 'https://openrouter.ai';
                node.credentials.siteName = 'OpenRouter';
            } else {
                customFields.show();
                // Keep current or empty
            }
        });

        editBtn.on('click', function() {
            siteSelector.val('custom');
            customFields.show();
            siteUrlInput.val(currentSiteUrl || 'https://yoursite.com');
            siteNameInput.val(currentSiteName || 'Your Site');
        });

        // Update credentials on custom input change
        siteUrlInput.on('change', function() {
            node.credentials.siteUrl = this.value;
        });
        siteNameInput.on('change', function() {
            node.credentials.siteName = this.value;
        });
    }
    });

                    dropdown.append(div);
                });

                if (matches.length > 0) {
                    dropdown.css('width', input.parent().outerWidth()).show();
                }
            });

            // Allow manual entry: on blur, try to find matching model and set object
            input.on('blur', function() {
                var val = input.val().trim();
                if (val && !node.model.id) {
                    var match = node.models.find(m => m.id === val || (m.name && m.name.toLowerCase() === val.toLowerCase()));
                    if (match) {
                        node.model = match.id;
                        display.text(match.name ? ` - ${match.name}` : '');
                    } else {
                        node.model = val;
                        display.text('');
                        node.warn('Unknown model ID; verify manually.');
                    }
                }
            });

            // Hide dropdown when clicking outside
            $(document).off('click.model-hide').on('click.model-hide', function(e) {
                if (!input.is(e.target) && !input.parent().is(e.target) && dropdown.has(e.target).length === 0) {
                    dropdown.hide();
                }
            });

            // Show all on focus if empty
            input.on('focus', function() {
                if (input.val().trim() === '' && node.models.length > 0) {
                    input.trigger('input');
                }
            });
        }
    });



    <script type="text/html" data-template-name="openrouter-config">
        <div class="form-row">
            <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
            <input type="text" id="node-config-input-name" placeholder="Name">
        </div>
        <div class="form-row">
            <label for="node-config-input-apiKey"><i class="fa fa-key"></i> API Key</label>
            <input type="password" id="node-config-input-apiKey" placeholder="Your OpenRouter API Key">
        </div>
        <div class="form-row">
            <label><i class="fa fa-globe"></i> Site</label>
            <select id="node-input-site-selector" style="flex: 1;">
                <option value="default">OpenRouter Default</option>
                <option value="custom">Custom</option>
            </select>
            <button type="button" id="edit-site-btn" style="margin-left: 8px; padding: 4px 8px; background: #ddd; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;">Edit</button>
            <div id="custom-site-fields" style="margin-top: 5px; display: none;">
                <input type="text" id="node-config-input-siteUrl" placeholder="Site URL (e.g., https://yoursite.com)" style="width: 100%; margin-bottom: 5px;">
                <input type="text" id="node-config-input-siteName" placeholder="Site Name" style="width: 100%;">
            </div>
        </div>
        <div class="form-row" style="position: relative;">
            <label for="node-input-model-id"><i class="fa fa-robot"></i> Model</label>
            <div style="display: flex; align-items: center;">
                <input type="text" id="node-input-model-id" placeholder="Search or select model ID" style="flex: 1;">
                <span id="model-name-display" style="margin-left: 8px; color: #666; font-style: italic;"></span>
            </div>
            <div id="model-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            </div>
        </div>
    </script>

    <script type="text/html" data-help-name="openrouter-config">
        <p>This node holds the configuration for the OpenRouter API, including the API key, model selection, and optional attribution details.</p>
        <h3>Configuration</h3>
        <ul>
            <li><strong>API Key:</strong> Your OpenRouter API key (required)</li>
            <li><strong>Model:</strong> Select or search for a model ID (saved as string; auto-selects on load if known).</li>
            <li><strong>Site:</strong> Choose default OpenRouter or custom site for attribution (optional; edit button for custom).</li>
        </ul>
    </script>